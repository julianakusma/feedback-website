// Seletores
const form = document.getElementById('form-feedback');
const lista = document.getElementById('lista-feedbacks');
const filtroCheckboxes = document.querySelectorAll('.filter-nota');
const ctx = document.getElementById('graficoNotas').getContext('2d');

let feedbacks = [];
let chart;

// Função para carregar do LocalStorage
function carregarFeedbacks() {
  const dados = localStorage.getItem('feedbacks');
  if (dados) {
    feedbacks = JSON.parse(dados);
  } else {
    feedbacks = [];
  }
}

// Função para salvar no LocalStorage
function salvarFeedbacks() {
  localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
}

// Função para renderizar lista com filtro
function renderizarLista() {
  const notasSelecionadas = Array.from(filtroCheckboxes)
    .filter(cb => cb.checked)
    .map(cb => Number(cb.value));

  const filtrados = feedbacks.filter(fb => notasSelecionadas.includes(fb.nota));

  lista.innerHTML = '';

  if (filtrados.length === 0) {
    lista.innerHTML = '<li>Nenhum feedback para os filtros selecionados.</li>';
    return;
  }

  filtrados.forEach(fb => {
    const li = document.createElement('li');

    li.innerHTML = `
      <div class="nome">${fb.nome}</div>
      <div class="nota">Nota: ${fb.nota}</div>
      <div class="comentario">${fb.comentario ? fb.comentario : '<em>Sem comentário</em>'}</div>
    `;

    lista.appendChild(li);
  });
}

// Função para atualizar gráfico
function atualizarGrafico() {
  // Contar número de notas 1 a 5
  const countNotas = [0, 0, 0, 0, 0];
  feedbacks.forEach(fb => {
    if (fb.nota >= 1 && fb.nota <= 5) {
      countNotas[fb.nota - 1]++;
    }
  });

  const data = {
    labels: ['1', '2', '3', '4', '5'],
    datasets: [{
      label: 'Quantidade de avaliações',
      data: countNotas,
      backgroundColor: [
        '#dc3545', // vermelho
        '#fd7e14', // laranja
        '#ffc107', // amarelo
        '#198754', // verde
        '#0d6efd'  // azul
      ]
    }]
  };

  if (chart) {
    chart.data = data;
    chart.update();
  } else {
    chart = new Chart(ctx, {
      type: 'bar',
      data: data,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            precision: 0,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }
}

// Evento ao enviar o formulário
form.addEventListener('submit', (e) => {
  e.preventDefault();

  const nome = form.nome.value.trim();
  const nota = parseInt(form.nota.value);
  const comentario = form.comentario.value.trim();

  if (!nome) {
    alert('Por favor, informe seu nome.');
    return;
  }

  if (isNaN(nota) || nota < 1 || nota > 5) {
    alert('Por favor, selecione uma nota válida de 1 a 5.');
    return;
  }

  const novoFeedback = { nome, nota, comentario };

  feedbacks.push(novoFeedback);
  salvarFeedbacks();
  renderizarLista();
  atualizarGrafico();

  form.reset();
});

// Evento para filtros
filtroCheckboxes.forEach(cb => {
  cb.addEventListener('change', () => {
    renderizarLista();
  });
});

// Inicialização
function init() {
  carregarFeedbacks();
  renderizarLista();
  atualizarGrafico();
}

init();
